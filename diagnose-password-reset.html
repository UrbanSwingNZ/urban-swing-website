<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset Diagnostics</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin-top: 0;
            color: #333;
        }
        
        .section {
            margin: 25px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
        
        .section h3 {
            margin-top: 0;
            color: #1976D2;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4CAF50;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196F3;
        }
        
        input, button {
            padding: 12px;
            border-radius: 6px;
            font-size: 15px;
            margin: 5px 0;
        }
        
        input {
            width: 100%;
            border: 2px solid #ddd;
            box-sizing: border-box;
        }
        
        input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: 500;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .log {
            background: #2a2a2a;
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .log div {
            margin: 3px 0;
        }
        
        .log .error-log {
            color: #ff6b6b;
        }
        
        .log .success-log {
            color: #51cf66;
        }
        
        .log .info-log {
            color: #74c0fc;
        }
        
        code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Password Reset Diagnostics</h1>
        <p>This tool will help diagnose why password reset emails aren't being sent.</p>
        
        <!-- Step 1: Check Firebase -->
        <div class="section">
            <h3>Step 1: Firebase Configuration Check</h3>
            <div id="firebase-status"></div>
        </div>
        
        <!-- Step 2: Check User Exists -->
        <div class="section">
            <h3>Step 2: Check User Exists in Firebase Auth</h3>
            <input 
                type="email" 
                id="check-email" 
                placeholder="Enter email to check"
            >
            <button id="check-user-btn">Check if User Exists</button>
            <div id="user-status"></div>
        </div>
        
        <!-- Step 3: Send Reset Email -->
        <div class="section">
            <h3>Step 3: Send Password Reset Email</h3>
            <input 
                type="email" 
                id="reset-email" 
                placeholder="Enter email for password reset"
            >
            <button id="send-reset-btn">Send Password Reset Email</button>
            <div id="reset-status"></div>
        </div>
        
        <!-- Debug Log -->
        <div class="section">
            <h3>Debug Log</h3>
            <div id="debug-log" class="log"></div>
        </div>
    </div>

    <!-- Firebase Config -->
    <script src="/config/firebase-config.js"></script>
    
    <script>
        // Debug logging
        const logDiv = document.getElementById('debug-log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `${type}-log`;
            div.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }
        
        // Step 1: Check Firebase Configuration
        function checkFirebaseConfig() {
            const statusDiv = document.getElementById('firebase-status');
            
            if (typeof firebase === 'undefined') {
                statusDiv.innerHTML = '<div class="status error">‚ùå Firebase SDK not loaded</div>';
                log('Firebase SDK not loaded', 'error');
                return;
            }
            
            log('Firebase SDK loaded', 'success');
            
            if (!firebase.auth) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Firebase Auth not initialized</div>';
                log('Firebase Auth not initialized', 'error');
                return;
            }
            
            log('Firebase Auth initialized', 'success');
            
            try {
                const config = firebase.app().options;
                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Firebase Initialized Successfully</div>
                    <div class="status info">
                        <strong>Project ID:</strong> ${config.projectId}<br>
                        <strong>Auth Domain:</strong> ${config.authDomain}<br>
                        <strong>API Key:</strong> ${config.apiKey.substring(0, 20)}...
                    </div>
                `;
                log(`Project: ${config.projectId}`, 'info');
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Firebase configuration error</div>';
                log(`Config error: ${error.message}`, 'error');
            }
        }
        
        // Step 2: Check if user exists
        document.getElementById('check-user-btn').addEventListener('click', async () => {
            const email = document.getElementById('check-email').value.trim().toLowerCase();
            const statusDiv = document.getElementById('user-status');
            const btn = document.getElementById('check-user-btn');
            
            if (!email) {
                statusDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è Please enter an email address</div>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Checking...';
            statusDiv.innerHTML = '<div class="status info">üîç Checking Firebase Authentication...</div>';
            log(`Checking user: ${email}`, 'info');
            
            try {
                // Check in Firestore users collection
                const usersSnapshot = await db.collection('users')
                    .where('email', '==', email)
                    .limit(1)
                    .get();
                
                if (!usersSnapshot.empty) {
                    const userData = usersSnapshot.docs[0].data();
                    statusDiv.innerHTML = `
                        <div class="status success">‚úÖ User found in Firestore 'users' collection</div>
                        <div class="status info">
                            <strong>Name:</strong> ${userData.firstName} ${userData.lastName}<br>
                            <strong>Role:</strong> ${userData.role}<br>
                            <strong>Student ID:</strong> ${userData.studentId || 'N/A'}
                        </div>
                        <div class="status warning">
                            ‚ö†Ô∏è <strong>Important:</strong> User exists in Firestore, which means they SHOULD have a Firebase Auth account.<br><br>
                            However, Firebase Auth's <code>sendPasswordResetEmail()</code> only sends emails to users that exist in Firebase Authentication.<br><br>
                            If the email isn't being sent, the user might be in Firestore but NOT in Firebase Auth.
                        </div>
                    `;
                    log(`User found in Firestore: ${userData.firstName} ${userData.lastName}`, 'success');
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">‚ùå User NOT found in Firestore 'users' collection</div>
                        <div class="status info">
                            This email (${email}) is not in the Firestore 'users' collection.<br>
                            Password reset will only work for users registered in Firebase Authentication.
                        </div>
                    `;
                    log(`User not found in Firestore: ${email}`, 'error');
                }
                
                // Also check students collection
                const studentsSnapshot = await db.collection('students')
                    .where('email', '==', email)
                    .limit(1)
                    .get();
                
                if (!studentsSnapshot.empty) {
                    const studentData = studentsSnapshot.docs[0].data();
                    const existingHTML = statusDiv.innerHTML;
                    statusDiv.innerHTML = existingHTML + `
                        <div class="status success">‚úÖ Also found in 'students' collection</div>
                        <div class="status info">
                            <strong>Name:</strong> ${studentData.firstName} ${studentData.lastName}
                        </div>
                    `;
                    log(`Student found: ${studentData.firstName} ${studentData.lastName}`, 'success');
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                log(`Error checking user: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Check if User Exists';
            }
        });
        
        // Step 3: Send password reset
        document.getElementById('send-reset-btn').addEventListener('click', async () => {
            const email = document.getElementById('reset-email').value.trim().toLowerCase();
            const statusDiv = document.getElementById('reset-status');
            const btn = document.getElementById('send-reset-btn');
            
            if (!email) {
                statusDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è Please enter an email address</div>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            statusDiv.innerHTML = '<div class="status info">üìß Attempting to send password reset email...</div>';
            log(`Attempting to send reset email to: ${email}`, 'info');
            
            try {
                await firebase.auth().sendPasswordResetEmail(email);
                
                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Firebase says email was sent successfully!</div>
                    <div class="status info">
                        <strong>Email sent to:</strong> ${email}<br><br>
                        <strong>Next steps:</strong><br>
                        1. Check your inbox (including spam/junk folder)<br>
                        2. Look for email from Firebase/noreply<br>
                        3. Email subject should be about password reset<br>
                        4. Click the link in the email to reset password<br><br>
                        <strong>If you don't receive the email:</strong><br>
                        ‚Ä¢ Check Firebase Console ‚Üí Authentication ‚Üí Users<br>
                        ‚Ä¢ Verify this email exists in the list<br>
                        ‚Ä¢ Check Firebase Console ‚Üí Authentication ‚Üí Templates<br>
                        ‚Ä¢ Verify email templates are configured<br>
                        ‚Ä¢ Check your email provider's spam filters
                    </div>
                `;
                log(`Password reset email sent successfully to: ${email}`, 'success');
                
            } catch (error) {
                log(`Error sending reset email: ${error.code} - ${error.message}`, 'error');
                
                let errorMessage = '';
                let troubleshootingSteps = '';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = `No Firebase Auth user found with email: ${email}`;
                    troubleshootingSteps = `
                        <strong>This is the problem!</strong><br><br>
                        The email exists in your Firestore database but NOT in Firebase Authentication.<br><br>
                        <strong>To fix this:</strong><br>
                        1. Go to Firebase Console ‚Üí Authentication ‚Üí Users<br>
                        2. Check if this email is in the list<br>
                        3. If not, the user was never created in Firebase Auth<br>
                        4. You may need to create their auth account or have them re-register
                    `;
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email format';
                    troubleshootingSteps = 'Check the email address is correctly formatted.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many password reset requests';
                    troubleshootingSteps = 'Wait a few minutes before trying again.';
                } else {
                    errorMessage = error.message;
                    troubleshootingSteps = `Error code: ${error.code}`;
                }
                
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå ${errorMessage}</div>
                    <div class="status warning">${troubleshootingSteps}</div>
                `;
                
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Password Reset Email';
            }
        });
        
        // Run Firebase check on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkFirebaseConfig();
            }, 500);
        });
    </script>
</body>
</html>
