/**
 * concession-notifications.js
 * Email templates for concession-related notifications
 */

/**
 * Generate email for when a student has only 1 concession remaining
 * @param {Object} student - Student data
 * @param {string} student.firstName - Student's first name
 * @param {string} student.email - Student's email
 * @param {number} remainingBalance - Number of active concessions remaining (should be 1)
 * @returns {Object} Object with html and text versions
 */
function generateLowBalanceEmail(student, remainingBalance = 1) {
  // Email color mappings from styles/base/colors.css
  const colors = {
    bluePrimary: '#3534fa',      // --blue-primary
    purplePrimary: '#9a16f5',    // --purple-primary
    pinkPrimary: '#e800f2',      // --pink-primary
    white: '#ffffff',            // --white
    textLight: '#666',           // --text-light
    textPrimary: '#333',         // --text-primary
    bgLight: '#f8f9fa',          // --bg-light / --gray-200
    warning: '#ffc107',          // --warning
    borderMedium: '#ddd',        // --gray-500
  };

  const html = `
    <!-- Generated by JS: concession-notifications.js > generateLowBalanceEmail -->
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: linear-gradient(135deg, ${colors.bluePrimary} 0%, ${colors.purplePrimary} 50%, ${colors.pinkPrimary} 100%); padding: 20px; text-align: center;">
        <h1 style="color: ${colors.white}; margin: 0;">üé´ Your Concessions Are Running Low</h1>
      </div>
      
      <div style="padding: 30px; background: ${colors.white};">
        <p style="color: ${colors.textPrimary}; font-size: 16px; line-height: 1.6;">
          Hi ${student.firstName},
        </p>
        
        <div style="background: ${colors.bgLight}; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid ${colors.warning};">
          <p style="color: ${colors.textPrimary}; font-size: 18px; font-weight: bold; margin: 0 0 10px 0;">
            ‚ö†Ô∏è You have ${remainingBalance} concession${remainingBalance === 1 ? '' : 's'} remaining
          </p>
          <p style="color: ${colors.textLight}; margin: 0;">
            This is a friendly reminder that your concession balance is running low. Consider purchasing more concessions to keep dancing!
          </p>
        </div>
        
        <h2 style="color: ${colors.purplePrimary}; margin-top: 30px;">Ready to Top Up?</h2>
        
        <p style="color: ${colors.textPrimary}; font-size: 16px; line-height: 1.6;">
          You can purchase more concessions by logging into the Student Portal.
        </p>
        
        <p style="color: ${colors.textPrimary}; font-size: 16px; line-height: 1.6;">
          Don't have a student portal account? Click the button below to create one! You can purchase concessions, single class entries, view your check in history, and manage your personal details.
        </p>
        
        <div style="text-align: center; margin: 30px 0;">
          <a href="https://urbanswing.co.nz/student-portal/" 
             style="display: inline-block; background: linear-gradient(135deg, ${colors.bluePrimary} 0%, ${colors.purplePrimary} 50%, ${colors.pinkPrimary} 100%); color: ${colors.white}; text-decoration: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; font-size: 16px;">
            Visit Student Portal
          </a>
        </div>
        
        <p style="color: ${colors.textPrimary}; font-size: 16px; line-height: 1.6;">
          See you on the dance floor!
        </p>
        
        <p style="color: ${colors.textPrimary}; font-size: 16px; line-height: 1.6;">
          The Urban Swing Team
        </p>
      </div>
      
      <!-- Footer with opt-out info -->
      <div style="background: ${colors.bgLight}; padding: 20px; border-top: 1px solid ${colors.borderMedium};">
        <p style="color: ${colors.textLight}; font-size: 12px; line-height: 1.6; margin: 0 0 10px 0;">
          <strong>Manage Your Email Preferences</strong><br>
          You can opt out of these notification emails by updating your preferences in the Student Portal. 
          If you haven't set up your Student Portal account yet, you can register at 
          <a href="https://urbanswing.co.nz/student-portal/register.html" style="color: ${colors.purplePrimary};">urbanswing.co.nz/student-portal/register.html</a>
        </p>
        <p style="color: ${colors.textLight}; font-size: 12px; line-height: 1.6; margin: 0;">
          Urban Swing | Hawkes Bay, New Zealand<br>
          <a href="mailto:dance@urbanswing.co.nz" style="color: ${colors.purplePrimary};">dance@urbanswing.co.nz</a>
        </p>
      </div>
    </div>
  `;

  const text = `
Hi ${student.firstName},

YOUR CONCESSIONS ARE RUNNING LOW

You have ${remainingBalance} concession${remainingBalance === 1 ? '' : 's'} remaining.

This is a friendly reminder that your concession balance is running low. Consider purchasing more concessions to keep dancing!

READY TO TOP UP?

You can purchase more concessions by logging into the Student Portal.

Don't have a student portal account? Click the button below to create one! You can purchase concessions, single class entries, view you check in history, and manage your personal details.

Visit the Student Portal: https://urbanswing.co.nz/student-portal/

See you on the dance floor!

The Urban Swing Team

---
MANAGE YOUR EMAIL PREFERENCES
You can opt out of these notification emails by updating your preferences in the Student Portal.
If you haven't set up your Student Portal account yet, you can register at:
https://urbanswing.co.nz/student-portal/register.html

Urban Swing | Hawkes Bay, New Zealand
dance@urbanswing.co.nz
  `.trim();

  return { html, text };
}

/**
 * Generate email for when concessions are expiring soon (4 weeks warning)
 * @param {Object} student - Student data
 * @param {string} student.firstName - Student's first name
 * @param {string} student.email - Student's email
 * @param {Array} expiringBlocks - Array of concession blocks expiring soon
 * @param {number} expiringBlocks[].remainingQuantity - Number of entries remaining
 * @param {Date} expiringBlocks[].expiryDate - When the block expires
 * @param {string} expiringBlocks[].packageName - Name of the concession package
 * @returns {Object} Object with html and text versions
 */
function generateExpiringConcessionsEmail(student, expiringBlocks) {
  // Email color mappings from styles/base/colors.css
  const colors = {
    bluePrimary: '#3534fa',      // --blue-primary
    purplePrimary: '#9a16f5',    // --purple-primary
    pinkPrimary: '#e800f2',      // --pink-primary
    white: '#ffffff',            // --white
    textLight: '#666',           // --text-light
    textPrimary: '#333',         // --text-primary
    bgLight: '#f8f9fa',          // --bg-light / --gray-200
    warning: '#ffc107',          // --warning
    borderMedium: '#ddd',        // --gray-500
    borderLight: '#e0e0e0',      // --border-light
  };

  // Calculate total expiring concessions
  const totalExpiring = expiringBlocks.reduce((sum, block) => sum + block.remainingQuantity, 0);

  // Format expiry dates
  const formatDate = (date) => {
    const d = date instanceof Date ? date : new Date(date);
    return d.toLocaleDateString('en-NZ', { day: 'numeric', month: 'long', year: 'numeric' });
  };

  // Generate block list HTML
  const blockListHtml = expiringBlocks.map(block => `
    <tr>
      <td style="padding: 10px; border-bottom: 1px solid ${colors.borderLight};">${block.packageName}</td>
      <td style="padding: 10px; border-bottom: 1px solid ${colors.borderLight}; text-align: center;">${block.remainingQuantity}</td>
      <td style="padding: 10px; border-bottom: 1px solid ${colors.borderLight}; text-align: right;">${formatDate(block.expiryDate)}</td>
    </tr>
  `).join('');

  // Generate block list text
  const blockListText = expiringBlocks.map(block => 
    `- ${block.packageName}: ${block.remainingQuantity} concession${block.remainingQuantity === 1 ? '' : 's'} expiring on ${formatDate(block.expiryDate)}`
  ).join('\n');

  const html = `
    <!-- Generated by JS: concession-notifications.js > generateExpiringConcessionsEmail -->
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: linear-gradient(135deg, ${colors.bluePrimary} 0%, ${colors.purplePrimary} 50%, ${colors.pinkPrimary} 100%); padding: 20px; text-align: center;">
        <h1 style="color: ${colors.white}; margin: 0;">‚è∞ Your Concessions Are Expiring Soon</h1>
      </div>
      
      <div style="padding: 30px; background: ${colors.white};">
        <p style="color: ${colors.textPrimary}; font-size: 16px; line-height: 1.6;">
          Hi ${student.firstName},
        </p>
        
        <div style="background: ${colors.bgLight}; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid ${colors.warning};">
          <p style="color: ${colors.textPrimary}; font-size: 18px; font-weight: bold; margin: 0 0 10px 0;">
            ‚ö†Ô∏è ${totalExpiring} concession${totalExpiring === 1 ? '' : 's'} expiring within 4 weeks
          </p>
          <p style="color: ${colors.textLight}; margin: 0;">
            This is a friendly reminder that some of your concessions will expire soon. Use them before they expire, or they'll go to waste!
          </p>
        </div>
        
        <h2 style="color: ${colors.purplePrimary}; margin-top: 30px;">Concessions Expiring Soon</h2>
        
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
          <thead>
            <tr style="background: ${colors.bgLight};">
              <th style="padding: 12px 10px; text-align: left; border-bottom: 2px solid ${colors.borderMedium}; color: ${colors.textPrimary};">Package</th>
              <th style="padding: 12px 10px; text-align: center; border-bottom: 2px solid ${colors.borderMedium}; color: ${colors.textPrimary};">Remaining</th>
              <th style="padding: 12px 10px; text-align: right; border-bottom: 2px solid ${colors.borderMedium}; color: ${colors.textPrimary};">Expiry Date</th>
            </tr>
          </thead>
          <tbody>
            ${blockListHtml}
          </tbody>
        </table>
        
        <h2 style="color: ${colors.purplePrimary}; margin-top: 30px;">Don't Let Them Go to Waste!</h2>
        
        <p style="color: ${colors.textPrimary}; font-size: 16px; line-height: 1.6;">
          Make sure to use your concessions before they expire. We'd love to see you at our upcoming classes!
        </p>
        
        <p style="color: ${colors.textPrimary}; font-size: 16px; line-height: 1.6;">
          If you have questions about your concessions, get in touch.
        </p>
        
        <p style="color: ${colors.textPrimary}; font-size: 16px; line-height: 1.6;">
          See you on the dance floor!
        </p>
        
        <p style="color: ${colors.textPrimary}; font-size: 16px; line-height: 1.6;">
          The Urban Swing Team
        </p>
      </div>
      
      <!-- Footer with opt-out info -->
      <div style="background: ${colors.bgLight}; padding: 20px; border-top: 1px solid ${colors.borderMedium};">
        <p style="color: ${colors.textLight}; font-size: 12px; line-height: 1.6; margin: 0 0 10px 0;">
          <strong>Manage Your Email Preferences</strong><br>
          You can opt out of these notification emails by updating your preferences in the Student Portal. 
          If you haven't set up your Student Portal account yet, you can register at 
          <a href="https://urbanswing.co.nz/student-portal/register.html" style="color: ${colors.purplePrimary};">urbanswing.co.nz/student-portal/register.html</a>
        </p>
        <p style="color: ${colors.textLight}; font-size: 12px; line-height: 1.6; margin: 0;">
          Urban Swing | Hawkes Bay, New Zealand<br>
          <a href="mailto:dance@urbanswing.co.nz" style="color: ${colors.purplePrimary};">dance@urbanswing.co.nz</a>
        </p>
      </div>
    </div>
  `;

  const text = `
Hi ${student.firstName},

YOUR CONCESSIONS ARE EXPIRING SOON

${totalExpiring} concession${totalExpiring === 1 ? '' : 's'} expiring within 4 weeks.

This is a friendly reminder that some of your concessions will expire soon. Use them before they expire, or they'll go to waste!

CONCESSIONS EXPIRING SOON:

${blockListText}

DON'T LET THEM GO TO WASTE!

Make sure to use your concessions before they expire. We'd love to see you at our upcoming classes!

- Check our class schedule: https://urbanswing.co.nz/pages/classes.html
- Remember: Your concessions are your ticket to keep dancing
- If you have questions about your concessions, get in touch

See you on the dance floor!

The Urban Swing Team

---
MANAGE YOUR EMAIL PREFERENCES
You can opt out of these notification emails by updating your preferences in the Student Portal.
If you haven't set up your Student Portal account yet, you can register at:
https://urbanswing.co.nz/student-portal/register.html

Urban Swing | Hawkes Bay, New Zealand
dance@urbanswing.co.nz
  `.trim();

  return { html, text };
}

module.exports = {
  generateLowBalanceEmail,
  generateExpiringConcessionsEmail,
};
