rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to check if user exists
    function userExists() {
      return request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Helper function to check if user is admin or front-desk
    function isAdminOrFrontDesk() {
      return userExists() && getUserData().role in ['admin', 'front-desk'];
    }
    
    // Helper function to check if user is student
    function isStudent() {
      return userExists() && getUserData().role == 'student';
    }
    
    // Helper function to get user's studentId
    function getStudentId() {
      return getUserData().studentId;
    }
    
    // Allow authenticated users (including anonymous) to read/write their own admin tokens
    match /admin_tokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Students collection (for student database system)
    match /students/{studentId} {
      // Admins and front-desk can read and write everything
      allow read, write: if isAdminOrFrontDesk();
      
      // Students can read their own student document (via users collection link)
      allow read: if isStudent() && studentId == getStudentId();
      
      // Students can also read their own document by matching email
      allow read: if request.auth != null && 
                     resource.data.email == request.auth.token.email;
      
      // Students can update specific fields in their own profile (via users collection link)
      allow update: if isStudent() && 
                       studentId == getStudentId() &&
                       // Only allow updating these specific fields
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['firstName', 'lastName', 'email', 'phoneNumber', 
                                  'pronouns', 'emailConsent', 'adminNotes']) &&
                       // Ensure required fields remain present
                       request.resource.data.keys().hasAll([
                         'firstName', 'lastName', 'email', 'phoneNumber', 
                         'emailConsent', 'registeredAt'
                       ]);
      
      // Students can also update their own profile by matching email (for direct student portal access)
      allow update: if request.auth != null && 
                       resource.data.email == request.auth.token.email &&
                       // Only allow updating these specific fields
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['firstName', 'lastName', 'email', 'phoneNumber', 
                                  'pronouns', 'emailConsent', 'adminNotes']) &&
                       // Ensure required fields remain present
                       request.resource.data.keys().hasAll([
                         'firstName', 'lastName', 'email', 'phoneNumber', 
                         'emailConsent', 'registeredAt'
                       ]);
      
      // Public users can read for duplicate checking (limited to querying by their own email)
      allow read: if request.query.limit <= 10;
      
      // Public users can create (for self-registration)
      allow create: if request.resource.data.keys().hasAll([
        'firstName', 'lastName', 'email', 'phoneNumber', 
        'over16Confirmed', 'emailConsent', 'registeredAt'
      ]);
    }
    
    // Concession Packages - public can read, admins can write
    match /concessionPackages/{packageId} {
      allow read: if true;  // Public read access for pricing display
      allow write: if isAdminOrFrontDesk();
    }
    
    // Casual Rates - public can read, admins can write
    match /casualRates/{rateId} {
      allow read: if true;  // Public read access for pricing display
      allow write: if isAdminOrFrontDesk();
    }
    
    // Concession Blocks
    match /concessionBlocks/{blockId} {
      // Admins and front-desk can read and write everything
      allow read, write: if isAdminOrFrontDesk();
      
      // Students can read their own concession blocks
      allow read: if isStudent() && resource.data.studentId == getStudentId();
    }
    
    // Transactions
    match /transactions/{transactionId} {
      // Admins and front-desk can read and write everything
      allow read, write: if isAdminOrFrontDesk();
      
      // Students can read their own transactions
      allow read: if isStudent() && resource.data.studentId == getStudentId();
    }
    
    // Check-ins
    match /checkins/{checkinId} {
      // Admins and front-desk can read and write everything
      allow read, write: if isAdminOrFrontDesk();
      
      // Students can read their own check-ins
      allow read: if isStudent() && resource.data.studentId == getStudentId();
    }
    
    // Users collection (for student portal authentication)
    match /users/{userId} {
      // Admins and front-desk can read and write everything
      allow read, write: if isAdminOrFrontDesk();
      
      // Any authenticated user can read their own user document (needed for isStudent() check)
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Allow querying by studentId (for backend functions)
      allow read: if request.query.limit <= 10;
      
      // Public users can create their own user document during registration (backend only)
      allow create: if request.resource.data.keys().hasAll([
        'email', 'firstName', 'lastName', 'studentId', 'role', 'createdAt'
      ]) && request.resource.data.role == 'student';
    }
    
    // Closedown Nights - public can read, admins can write
    match /closedownNights/{nightId} {
      allow read: if true;  // Public read access for calendar and banner display
      allow write: if isAdminOrFrontDesk();
    }
    
    // Settings collection - public can read, admins can write
    match /settings/{settingId} {
      allow read: if true;  // Public read access for configuration
      allow write: if isAdminOrFrontDesk();
    }
    
    // Email Templates - restricted to dance@urbanswing.co.nz only
    match /emailTemplates/{templateId} {
      allow read, write: if request.auth != null && 
                            request.auth.token.email == 'dance@urbanswing.co.nz';
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
