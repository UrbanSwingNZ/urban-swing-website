rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow authenticated users (including anonymous) to read/write their own admin tokens
    match /admin_tokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Students collection (for student database system)
    match /students/{studentId} {
      // Admins (authenticated users) can read and write everything
      allow read, write: if request.auth != null;
      
      // Public users can read for duplicate checking (limited to querying by their own email)
      allow read: if request.query.limit <= 10;
      
      // Public users can create (for self-registration)
      allow create: if request.resource.data.keys().hasAll([
        'firstName', 'lastName', 'email', 'phoneNumber', 
        'over16Confirmed', 'emailConsent', 'registeredAt'
      ]);
    }
    
    // Concession Packages - public can read, admins can write
    match /concessionPackages/{packageId} {
      allow read: if true;  // Public read access for pricing display
      allow write: if request.auth != null;  // Only authenticated users can modify
    }
    
    // Casual Rates - public can read, admins can write
    match /casualRates/{rateId} {
      allow read: if true;  // Public read access for pricing display
      allow write: if request.auth != null;  // Only authenticated users can modify
    }
    
    // Concession Blocks - admins can read/write
    match /concessionBlocks/{blockId} {
      allow read, write: if request.auth != null;
    }
    
    // Transactions - admins can read/write
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null;
    }
    
    // Check-ins - admins can read/write
    match /checkins/{checkinId} {
      allow read, write: if request.auth != null;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
