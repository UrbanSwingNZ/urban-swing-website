<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Student Check-In - Urban Swing Admin</title>
    <link rel="stylesheet" href="../admin.css?v=2">
    <link rel="stylesheet" href="../admin-modals.css?v=2">
    <link rel="stylesheet" href="../student-database/student-database.css?v=2">
    <link rel="stylesheet" href="../student-database/js/transaction-history/transaction-history.css?v=2">
    <link rel="stylesheet" href="../concessions/concessions.css?v=2">
    <link rel="stylesheet" href="../../styles/date-picker/date-picker.css">
    <link rel="stylesheet" href="../../styles/base/colors.css">
    <link rel="stylesheet" href="../../styles/base/buttons.css">
    
    <!-- Modal System -->
    <link rel="stylesheet" href="/styles/modals/modal-base.css">
    <link rel="stylesheet" href="/styles/modals/confirmation-modal.css">
    
    <link rel="stylesheet" href="check-in.css?v=8">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="/images/icons/favicon.ico" type="image/x-icon">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <!-- Main Container -->
    <div id="main-container" class="dashboard-container" style="display: none;">
        <!-- Header -->

        <!-- Main Content -->
        <main class="checkin-main">
            <!-- Check-In Header with Date Picker -->
            <div class="checkin-header">
                <div class="checkin-actions">
                    <button class="btn-primary btn-primary-lg" id="checkin-btn">
                        <i class="fas fa-user-check"></i> Check In Student
                    </button>
                    <button class="btn-primary btn-primary-lg" id="register-student-btn">
                        <i class="fas fa-user-plus"></i> Register New Student
                    </button>
                </div>
                <div class="date-picker-container">
                    <label for="checkin-date" class="date-label">
                        <i class="fas fa-calendar-alt"></i> Check-In Date:
                    </label>
                    <div class="date-input-wrapper">
                        <input type="text" id="checkin-date" class="date-input" readonly placeholder="Select date" />
                        <i class="fas fa-calendar-alt date-input-icon"></i>
                    </div>
                    <div id="checkin-calendar" class="custom-calendar" style="display: none;"></div>
                </div>
            </div>

            <!-- Today's Check-Ins -->
            <div class="checkins-section">
                <div class="section-header accordion-header" id="checkins-header">
                    <div class="section-title">
                        <i class="fas fa-chevron-down accordion-icon"></i>
                        <h2><span id="checkin-date-display">Today's</span> Check-Ins</h2>
                        <span class="checkin-count" id="checkin-count">0</span>
                        <span class="crew-count" id="crew-count">0</span>
                    </div>
                    <div class="section-actions">
                        <div class="toggle-group">
                            <label class="toggle-switch">
                                <input type="checkbox" id="show-reversed-checkins-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                            <label for="show-reversed-checkins-toggle" class="toggle-label">
                                <i class="fas fa-undo"></i> Show Reversed
                            </label>
                        </div>
                        <button class="btn-secondary" id="view-history-btn">
                            <i class="fas fa-history"></i> View History
                        </button>
                    </div>
                </div>

                <div class="accordion-content" id="checkins-content">
                    <!-- Empty State -->
                    <div id="empty-state" class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <h3>No Check-Ins Yet</h3>
                        <p>Click "Check In Student" to get started.</p>
                    </div>

                    <!-- Check-Ins List -->
                    <div id="checkins-list" class="checkins-list" style="display: none;">
                        <!-- Today's check-ins will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Financial Transactions -->
            <div class="transactions-section">
                <div class="section-header accordion-header" id="transactions-header">
                    <div class="section-title">
                        <i class="fas fa-chevron-down accordion-icon"></i>
                        <h2><span id="transactions-date-display">Today's</span> Transactions</h2>
                    </div>
                </div>

                <div class="accordion-content" id="transactions-content">
                    <div class="summary-row">
                        <div class="summary-item">
                            <span class="summary-label">Total Transactions:</span>
                            <span class="summary-value" id="checkin-total-count">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Total Amount:</span>
                            <span class="summary-value" id="checkin-total-amount">$0.00</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Cash:</span>
                            <span class="summary-value" id="checkin-total-cash">$0.00</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">EFTPOS:</span>
                            <span class="summary-value" id="checkin-total-eftpos">$0.00</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Online:</span>
                            <span class="summary-value" id="checkin-total-online">$0.00</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Bank Transfer:</span>
                            <span class="summary-value" id="checkin-total-bank">$0.00</span>
                        </div>
                    </div>

                    <!-- Transactions Table -->
                    <div class="table-container">
                        <table id="checkin-transactions-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student Name</th>
                                    <th>Type</th>
                                    <th class="align-right">Amount</th>
                                    <th>Payment Method</th>
                                    <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="checkin-transactions-tbody">
                            <!-- Transactions will be loaded here -->
                        </tbody>
                    </table>
                    
                    <!-- Empty State -->
                    <div id="transactions-empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-receipt"></i>
                        <p>No transactions for this date</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Check-In Modal -->
    <div id="checkin-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-check"></i> Check In Student</h3>
                <button class="modal-close" onclick="closeCheckinModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Student Selection (if opened without search) -->
                <div id="student-selection" class="form-group">
                    <label><i class="fas fa-user"></i> Student</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="modal-student-search" placeholder="Search student name..." class="form-control" autocomplete="off">
                        <button type="button" class="clear-search-btn" id="clear-modal-search" style="display: none;">&times;</button>
                        <div id="modal-search-results" class="search-results-modal" style="display: none;"></div>
                    </div>
                </div>

                <!-- Selected Student Info -->
                <div id="selected-student-info" style="display: none;">
                    <div class="student-info-card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h4 id="selected-student-name">Student Name</h4>
                                <p id="selected-student-email">email@example.com</p>
                            </div>
                            <button type="button" class="btn-icon" id="view-student-details-btn" title="View Student Details">
                                <i class="fas fa-user"></i>
                            </button>
                        </div>
                        <input type="hidden" id="selected-student-id">
                    </div>

                    <!-- Concession Balance -->
                    <div id="concession-info" class="concession-info">
                        <div class="concession-header">
                            <i class="fas fa-ticket-alt"></i>
                            <strong>Concession Balance:</strong>
                            <span id="concession-balance">0</span>
                        </div>
                        <div id="concession-blocks" class="concession-blocks">
                            <!-- Concession block details will be shown here -->
                        </div>
                    </div>

                    <!-- Purchase Concessions -->
                    <div class="purchase-section">
                        <button type="button" class="btn-secondary btn-purchase" id="purchase-concessions-btn">
                            <i class="fas fa-shopping-cart"></i> Purchase Concessions
                        </button>
                    </div>

                    <!-- Entry Type Selection -->
                    <div class="form-group">
                        <label><i class="fas fa-sign-in-alt"></i> Entry Type</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="entry-type" value="concession" id="entry-concession">
                                <span class="radio-label">Use Concession</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="entry-type" value="casual" id="entry-casual">
                                <span class="radio-label">Casual Entry ($15)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="entry-type" value="casual-student" id="entry-casual-student">
                                <span class="radio-label">Casual Student ($12)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="entry-type" value="online-payment" id="entry-online-payment">
                                <span class="radio-label">Online Payment</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="entry-type" value="free" id="entry-free">
                                <span class="radio-label">Free Entry</span>
                            </label>
                        </div>
                        
                        <!-- Online Payment Validation Messages -->
                        <div id="online-payment-messages" class="online-payment-messages" style="display: none;">
                            <!-- Messages will be displayed here -->
                        </div>
                    </div>

                    <!-- Payment Method (for casual) -->
                    <div id="payment-section" class="form-group" style="display: none;">
                        <label><i class="fas fa-credit-card"></i> Payment Method</label>
                        <select id="payment-method" class="form-control">
                            <option value="">Select payment method</option>
                            <option value="cash">Cash</option>
                            <option value="eftpos">EFTPOS</option>
                            <option value="bank-transfer">Bank Transfer</option>
                        </select>
                    </div>

                    <!-- Free Entry Reason (for free entry) -->
                    <div id="free-entry-section" class="form-group" style="display: none;">
                        <label><i class="fas fa-gift"></i> Free Entry Reason</label>
                        <select id="free-entry-reason" class="form-control">
                            <option value="">Select reason</option>
                            <option value="crew-member">Crew Member</option>
                            <option value="promotion">Promotion</option>
                            <option value="special-guest">Special Guest</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Notes (Optional)</label>
                        <textarea id="checkin-notes" class="form-control" rows="3" placeholder="Add any notes about this check-in..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCheckinModal()">Cancel</button>
                <button type="button" class="btn-primary" id="confirm-checkin-btn" disabled>
                    <i class="fas fa-check"></i> Complete Check-In
                </button>
            </div>
        </div>
    </div>

    <!-- Purchase Concessions Modal is now dynamically created by concessions-modal.js -->

    <!-- History Modal -->
    <div id="history-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i class="fas fa-history"></i> Check-In History</h3>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="history-filters">
                    <div class="filter-group date-range-group">
                        <label>Date Range:</label>
                        <div class="date-range-inputs">
                            <div class="date-picker-container">
                                <span class="date-label">
                                    <i class="fas fa-calendar-alt"></i>
                                    From:
                                </span>
                                <div class="date-input-wrapper">
                                    <input type="date" id="history-date-from" class="date-input">
                                    <button class="calendar-button" type="button" aria-label="Open calendar">
                                        <i class="fas fa-calendar-day"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="date-picker-container">
                                <span class="date-label">
                                    <i class="fas fa-calendar-alt"></i>
                                    To:
                                </span>
                                <div class="date-input-wrapper">
                                    <input type="date" id="history-date-to" class="date-input">
                                    <button class="calendar-button" type="button" aria-label="Open calendar">
                                        <i class="fas fa-calendar-day"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Student:</label>
                        <div class="student-search-wrapper">
                            <input type="text" id="history-student-search" class="form-control" placeholder="All Students" autocomplete="off">
                            <button type="button" class="clear-search-btn" id="clear-history-search" style="display: none;">&times;</button>
                            <div id="history-search-results" class="search-results-dropdown" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <div class="history-results">
                    <p class="results-count" id="history-count">0 check-ins found</p>
                    <div id="history-list" class="history-list">
                        <!-- History items will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeHistoryModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div id="student-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Student Details</h2>
                <button class="modal-close" onclick="closeStudentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="student-form" onsubmit="saveStudentChanges(event)">
                    <input type="hidden" id="modal-student-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modal-firstName">First Name</label>
                            <input type="text" id="modal-firstName" readonly>
                        </div>
                        <div class="form-group">
                            <label for="modal-lastName">Last Name</label>
                            <input type="text" id="modal-lastName" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="modal-email">Email</label>
                        <input type="email" id="modal-email" readonly>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="modal-phoneNumber">Phone Number</label>
                            <input type="tel" id="modal-phoneNumber" readonly>
                        </div>
                        <div class="form-group">
                            <label for="modal-pronouns">Pronouns</label>
                            <input type="text" id="modal-pronouns" readonly>
                        </div>
                    </div>

                    <div class="form-row checkbox-row">
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="modal-emailConsent" disabled>
                                <span>Email updates</span>
                            </label>
                        </div>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="modal-over16Confirmed" disabled>
                                <span>Over 16 confirmed</span>
                            </label>
                        </div>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="modal-crewMember" disabled>
                                <span>Crew Member</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="modal-adminNotes">
                            <i class="fas fa-sticky-note"></i> Admin Notes
                        </label>
                        <textarea id="modal-adminNotes" rows="3" placeholder="Add internal notes about this student..."></textarea>
                    </div>

                    <div class="timestamps">
                        <div class="timestamp-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span class="timestamp-label">Registered:</span>
                            <span id="modal-registeredAt">—</span>
                        </div>
                        <div class="timestamp-item">
                            <i class="fas fa-clock"></i>
                            <span class="timestamp-label">Created:</span>
                            <span id="modal-createdAt">—</span>
                        </div>
                        <div class="timestamp-item">
                            <i class="fas fa-edit"></i>
                            <span class="timestamp-label">Updated:</span>
                            <span id="modal-updatedAt">—</span>
                        </div>
                    </div>

                    <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="modal-actions-left">
                            <button type="button" class="btn-icon" id="edit-student-modal-btn" title="Edit Student">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn-icon" id="transaction-history-btn" title="View Transaction History">
                                <i class="fas fa-history"></i>
                            </button>
                            <button type="button" class="btn-icon" id="purchase-concessions-modal-btn" title="Purchase Concessions">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                        </div>
                        <div class="modal-actions-right">
                            <button type="button" class="btn-secondary" onclick="closeStudentModal()">
                                <i class="fas fa-times"></i> Close
                            </button>
                            <button type="submit" class="btn-primary" id="save-student-btn" style="display: none;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transaction History Modal -->
    <div id="transaction-history-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-history"></i> Transaction History</h3>
                <button class="modal-close" onclick="closeTransactionHistoryModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="transaction-student-info">
                    <h3 id="transaction-history-student-name"></h3>
                    <p id="transaction-history-student-email"></p>
                </div>
                
                <div class="transaction-tabs">
                    <button class="transaction-tab active" data-tab="attendance-content">
                        <i class="fas fa-calendar-check"></i> Attendance
                    </button>
                    <button class="transaction-tab" data-tab="payments-content">
                        <i class="fas fa-dollar-sign"></i> Payments
                    </button>
                    <button class="transaction-tab" data-tab="concessions-content">
                        <i class="fas fa-ticket-alt"></i> Concessions
                    </button>
                </div>
                
                <div class="transaction-tab-content active" id="attendance-content">
                    <!-- Attendance content will be loaded here -->
                </div>
                
                <div class="transaction-tab-content" id="payments-content">
                    <!-- Payment content will be loaded here -->
                </div>
                
                <div class="transaction-tab-content" id="concessions-content">
                    <!-- Concession content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Config & Scripts -->
    <script src="../../config/firebase-config.js"></script>
    
    <!-- Date Picker Component -->
    <script src="../../functions/date-picker/date-picker.js"></script>
    
    <script src="../../js/casual-rates-utils.js"></script>
    
    <!-- Check-In Modules (load in dependency order) -->
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/date-manager.js"></script>
    <script src="js/casual-rate-display.js"></script>
    <script src="js/students.js"></script>
    <script src="js/concessions.js"></script>
    
    <!-- Student Database Module (for student details modal) -->
    <script type="module" src="../student-database/js/modal.js"></script>
    
    <!-- Transaction History Module -->
    <script src="../student-database/js/transaction-history/transaction-history-modal.js"></script>
    <script src="../student-database/js/transaction-history/transaction-history-attendance.js"></script>
    <script src="../student-database/js/transaction-history/transaction-history-payments.js"></script>
    <script src="../student-database/js/transaction-history/transaction-history-concessions.js"></script>
    
    <!-- Reusable Concessions Module (after students.js for dependencies) -->
    <script src="../concessions/js/concessions-data.js"></script>
    <script src="../concessions/js/concessions-modal.js"></script>
    <script src="../concessions/js/concessions-admin.js"></script>
    
    <!-- Continue Check-In Modules -->
    <!-- Concession blocks management (before check-in modules that use it) -->
    <!-- Load in order: balance (used by all), then others -->
    <script src="js/concession-blocks-balance.js"></script>
    <script src="js/concession-blocks-create.js"></script>
    <script src="js/concession-blocks-query.js"></script>
    <script src="js/concession-blocks-usage.js"></script>
    <script src="js/concession-blocks-lock.js?v=4"></script>
    <script src="js/concession-blocks-delete.js"></script>
    <script src="js/concession-blocks-maintenance.js"></script>
    
    <!-- Check-in modal modules (load in dependency order) -->
    <script src="js/checkin-state.js"></script>
    <script src="js/checkin-online-payment.js"></script>
    <script src="js/checkin-form.js"></script>
    <script src="js/checkin-student-search.js"></script>
    <script src="js/checkin-concession-display.js"></script>
    <script src="js/checkin-firestore.js"></script>
    <script src="js/checkin-modal.js"></script>
    
    <!-- History modal modules (load in dependency order) -->
    <script src="js/history-state.js"></script>
    <script src="js/history-filters.js"></script>
    <script src="js/history-student-search.js"></script>
    <script src="js/history-firestore.js"></script>
    <script src="js/history-display.js"></script>
    <script src="js/history-modal.js"></script>
    
    <script type="module" src="js/todays-checkins.js"></script>
    <script type="module" src="js/checkin-transactions.js"></script>
    <script src="js/accordion.js"></script>
    <script src="js/main.js"></script>
    
    <!-- Admin Header Dependencies -->
    <script src="/components/mobile-drawer.js"></script>
    <script src="../js/header-config.js"></script>
    <script src="../js/header-configurator.js"></script>
    <script src="../js/mobile-nav.js"></script>
    <script src="../admin-header.js"></script>
</body>
</html>
